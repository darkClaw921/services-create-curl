# Архитектура проекта: Менеджер Systemd-сервисов с Webhook Автоматизацией

## Общая структура проекта

```
services-create-curl/
├── service.sh              # Основной скрипт менеджера сервисов
├── webhook.sh              # Скрипт автоматизации CI/CD с webhook
├── README.md               # Документация пользователя
├── README_cert_https.md    # Документация по HTTPS сертификатам
├── example.png             # Скриншот примера использования
└── architecture.md         # Архитектурная документация
```

## Основные компоненты

### service.sh - Главный исполняемый файл
Bash-скрипт для создания и управления systemd-сервисами с графическим интерфейсом в терминале.

### webhook.sh - Система автоматизации CI/CD
Bash-скрипт для автоматического выполнения действий при получении уведомлений от GitHub webhook'ов.

#### Основные функции:

**Инициализация и конфигурация:**
- `init_services_list()` - создает директории и файлы для хранения списка сервисов
- `check_sudo()` - проверяет наличие прав суперпользователя
- `check_command()` - проверяет наличие команд в системе

**Управление уведомлениями:**
- `send_notification()` - отправка уведомлений через Telegram API
- `manage_notifications()` - интерфейс настройки уведомлений

**Создание сервисов:**
- `select_runtime()` - выбор режима запуска (Python, UV, Poetry, PHP, Shell)
- `select_file()` - выбор файла для создания сервиса
- `create_service()` - создание systemd-сервиса и скриптов уведомлений

**Управление сервисами:**
- `manage_services()` - просмотр списка созданных сервисов
- `service_control()` - управление конкретным сервисом
- `view_service_logs()` - просмотр журналов сервиса
- `edit_service_file()` - редактирование конфигурации сервиса

**Управление Nginx:**
- `list_nginx_configs()` - получение списка всех конфигураций nginx из /etc/nginx/sites-available/
- `show_nginx_config_info()` - отображение детальной информации о конфигурации nginx
- `manage_nginx_configs()` - главное меню управления конфигурациями nginx с выбором конфигурации
- `check_nginx_ports()` - проверка портов в конфигурациях nginx (вызывает manage_nginx_configs)
- `create_nginx_config()` - создание конфигурации nginx с доменом и портом, активация через симлинк, выпуск SSL сертификата
- `edit_nginx_config()` - редактирование конфигурации nginx через текстовый редактор с валидацией
- `delete_nginx_config()` - удаление конфигурации nginx с подтверждением и автоматическим отключением
- `toggle_nginx_config()` - включение/отключение конфигурации nginx через управление симлинками
- `issue_ssl_certificate()` - выпуск SSL сертификата для конфигурации с настройкой автообновления через systemd timer

**Пользовательский интерфейс:**
- `show_main_menu()` - главное меню приложения
- `clear_screen()` - очистка экрана

#### Функции webhook.sh:

**Инициализация webhook системы:**
- `init_webhook_system()` - создание директорий и файлов конфигурации
- `fix_automations_format()` - миграция старых форматов данных автоматизаций

**Обработка webhook событий:**
- `handle_ping_event()` - обработка ping событий от GitHub для проверки подключения
- `handle_push_event()` - обработка push событий и запуск автоматизаций
- `log_event()` - централизованное логирование всех событий

**Управление автоматизациями:**
- `create_automation()` - создание новой автоматизации с настройкой команд
- `manage_automations()` - интерфейс управления существующими автоматизациями  
- `test_automation_manual()` - принудительное тестирование автоматизации
- `simulate_push_event()` - эмуляция push события для отладки

**Webhook сервер:**
- `start_webhook_server()` - запуск HTTP сервера для приема webhook'ов
- Поддержка Python, socat и netcat в качестве сервера

**Система уведомлений:**
- `send_notification()` - отправка уведомлений через Telegram
- Интеграция с системой логирования

**Управление данными:**
- `cleanup_corrupted_data()` - очистка поврежденных данных автоматизаций
- `view_logs()` - просмотр журналов событий
- `system_settings()` - настройки порта и уведомлений

**Инициализация и конфигурация:**
- `init_webhook_system()` - создание директорий и файлов конфигурации
- `save_config()` - сохранение настроек системы

**Управление автоматизациями:**
- `create_automation()` - создание новой автоматизации CI/CD
- `manage_automations()` - управление существующими автоматизациями
- `view_automation_details()` - просмотр деталей автоматизации
- `delete_automation()` - удаление автоматизации
- `test_automation()` - тестирование автоматизации

**Webhook сервер:**
- `start_webhook_server()` - запуск/остановка/перезапуск webhook сервера
- `webhook_server()` - основная функция HTTP сервера
- `handle_webhook_request()` - обработка входящих webhook запросов

**Система мониторинга:**
- `log_event()` - логирование событий с временными метками
- `view_logs()` - просмотр журнала событий
- `send_notification()` - отправка уведомлений через Telegram

**Интеграция с service.sh:**
- `get_services_list()` - получение списка созданных сервисов из service.sh

## Поддерживаемые режимы запуска

1. **Python (python3)** - запуск Python-скриптов через системный интерпретатор
2. **UV Manager (uv run)** - запуск через UV менеджер пакетов
3. **Poetry (poetry run python)** - запуск через Poetry менеджер зависимостей
4. **PHP Server (php -S)** - запуск PHP-файлов как веб-сервер
5. **Shell Script (bash)** - запуск shell-скриптов через bash интерпретатор

## Структура данных

### Файлы конфигурации service.sh:
- `/var/lib/service-creator/created_services.list` - список созданных сервисов
- `/var/lib/service-creator/notifications/config` - настройки уведомлений
- `/var/lib/service-creator/notifications/{service_name}_notify.sh` - скрипты уведомлений для каждого сервиса

### Файлы конфигурации webhook.sh:
- `/var/lib/webhook-automation/config` - основная конфигурация webhook системы
- `/var/lib/webhook-automation/automations.list` - список созданных автоматизаций (ID|название|репозиторий|путь|ветка|команды|дата_создания|приватный|учетные_данные_зашифрованы)
- `/var/lib/webhook-automation/logs/webhook.log` - журнал событий автоматизации

### Системные файлы:
- `/etc/systemd/system/{service_name}.service` - файлы конфигурации systemd
- `/etc/nginx/sites-available/{domain}.conf` - конфигурации nginx
- `/etc/nginx/sites-enabled/{domain}.conf` - активированные конфигурации nginx (симлинки)

## Интеграции

### Telegram API
- Отправка уведомлений о статусе сервисов (service.sh)
- Отправка файлов логов (service.sh)
- Уведомления о событиях автоматизации (webhook.sh)
- Тестирование уведомлений

### GitHub Webhooks
- Получение уведомлений о push в репозиторий
- Фильтрация по веткам
- Автоматический запуск команд при обновлении кода

### Systemd
- Создание и управление службами
- Автозапуск сервисов
- Журналирование
- Интеграция с автоматизацией (перезапуск сервисов)

### Nginx
- Проверка портов в существующих конфигурациях
- Создание новых конфигураций reverse proxy
- Автоматическая активация конфигураций через симлинки
- Интеграция с certbot для выпуска SSL сертификатов
- Валидация конфигураций перед применением

## Безопасность

- Требует прав суперпользователя для управления системными сервисами
- Проверка корректности ввода пользователя
- Подтверждение критических операций (удаление сервисов/автоматизаций)
- Безопасное редактирование конфигурационных файлов
- Webhook secret для защиты от несанкционированных запросов
- Валидация входящих webhook данных
- Изоляция выполнения команд автоматизации

## Цветовая схема интерфейса

- GREEN - успешные операции и активные элементы
- RED - ошибки и неактивные элементы  
- YELLOW - предупреждения и информационные сообщения
- CYAN - пункты меню и заголовки
- BLUE - дополнительная информация
- BOLD - выделение важных элементов

## Функциональные возможности webhook.sh

### Создание автоматизаций
- Настройка Git репозитория и целевой ветки
- Выбор между использованием существующих сервисов и ручным вводом команд
- Интеграция с созданными в service.sh сервисами
- Автоматическое формирование команд перезапуска сервисов

### Webhook сервер
- HTTP сервер на настраиваемом порту (по умолчанию 9000)
- Обработка POST запросов от GitHub
- Парсинг JSON payload для определения ветки и репозитория
- Автоматический запуск соответствующих автоматизаций

### Система мониторинга
- Подробное логирование всех событий с временными метками
- Отправка уведомлений в Telegram о статусе выполнения
- Просмотр журналов через интерфейс
- Тестирование автоматизаций вручную

### Типы автоматизаций
1. **Интеграция с service.sh** - автоматический git pull и перезапуск systemd сервиса
2. **Пользовательские команды** - выполнение произвольных bash команд
3. **Комбинированные сценарии** - объединение нескольких операций

### Настройки безопасности
- Webhook secret для аутентификации GitHub запросов
- Настраиваемый порт для webhook сервера
- Изоляция выполнения команд
- Валидация входящих данных
- Шифрование учетных данных для приватных репозиториев (base64 + rot13)
- Поддержка Personal Access Token и username/password аутентификации

## Функциональные возможности Nginx (service.sh)

### Управление конфигурациями nginx
- Просмотр списка всех конфигураций в /etc/nginx/sites-available/
- Отображение детальной информации о каждой конфигурации:
  - Домены (server_name)
  - Порты прослушивания (listen)
  - Цели проксирования (proxy_pass)
  - Статус SSL сертификата
  - Статус активации конфигурации (sites-enabled)
- Цветная визуализация информации

### Редактирование конфигураций nginx
- Выбор конфигурации из списка для редактирования
- Открытие конфигурации в текстовом редакторе (vim/vi/nano)
- Автоматическая валидация конфигурации после редактирования (nginx -t)
- Автоматическая перезагрузка nginx при успешной валидации
- Откат изменений при обнаружении ошибок в конфигурации

### Удаление конфигураций nginx
- Выбор конфигурации для удаления
- Отображение информации о конфигурации перед удалением
- Подтверждение удаления (защита от случайного удаления)
- Автоматическое отключение конфигурации перед удалением
- Валидация и перезагрузка nginx после удаления

### Включение/отключение конфигураций nginx
- Активация конфигурации через создание симлинка в /etc/nginx/sites-enabled/
- Деактивация конфигурации через удаление симлинка
- Автоматическая валидация конфигурации перед активацией
- Автоматическая перезагрузка nginx после изменений
- Откат активации при обнаружении ошибок в конфигурации

### Выпуск SSL сертификата с автообновлением
- Автоматическое определение домена из конфигурации
- Выпуск SSL сертификата через certbot --nginx
- Автоматическая настройка HTTPS в конфигурации nginx
- Настройка автообновления через systemd timer (certbot.timer)
- Резервный вариант с рекомендацией настройки cron для автообновления
- Проверка наличия certbot перед выпуском сертификата
- Информирование о необходимых требованиях для успешного выпуска SSL
- Автоматическая активация конфигурации перед выпуском сертификата

### Создание конфигурации nginx
- Интерактивный запрос домена и порта
- Валидация введенных данных (корректность порта 1-65535)
- Создание reverse proxy конфигурации для проксирования на localhost:port
- Автоматическое создание файла в /etc/nginx/sites-available/{domain}.conf
- Проверка существования конфигурации с подтверждением перезаписи
- Активация конфигурации через создание симлинка в /etc/nginx/sites-enabled/
- Валидация конфигурации nginx перед применением (nginx -t)
- Автоматическая перезагрузка nginx после создания конфигурации
- Опциональный выпуск SSL сертификата через certbot --nginx
- Проверка наличия certbot перед выпуском сертификата
- Информирование о необходимых требованиях для успешного выпуска SSL

### Интеграция с SSL/TLS
- Использование certbot для автоматического выпуска Let's Encrypt сертификатов
- Автоматическая настройка HTTPS в конфигурации nginx
- Проверка доступности домена перед выпуском сертификата
- Информирование о требованиях (DNS настройка, открытые порты 80/443)
- Настройка автообновления сертификатов через systemd timer 